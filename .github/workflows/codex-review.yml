name: Codex Code Review Backend

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'backend/**'

jobs:
  codex-review-backend:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      final_message: ${{ steps.run_codex.outputs.final-message }}

    defaults:
      run:
        working-directory: backend
    
    steps:
      - uses: actions/checkout@v5
        with:
          # Explicitly check out the PR's merge commit
          ref: refs/pull/${{ github.event.pull_request.number }}/merge
      
      - name: Pre-fetch base and head refs for the PR
        run: |
          git fetch --no-tags origin \
            ${{ github.event.pull_request.base.ref }} \
            +refs/pull/${{ github.event.pull_request.number }}/head
      
      # Install Python dependencies if needed for Codex to understand the codebase
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      - name: Run Codex Code Review
        id: run_codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          sandbox: workspace-write
          prompt: |
            This is PR #${{ github.event.pull_request.number }} for ${{ github.repository }}.
            Base SHA: ${{ github.event.pull_request.base.sha }}
            Head SHA: ${{ github.event.pull_request.head.sha }}
            
            You are reviewing a FastAPI backend application with the following context:
            - Stack: FastAPI, SQLAlchemy, PostgreSQL, Docker
            - Key areas: Support tickets, dashboard, user management, observability
            - Code style: Follow PEP 8, use type hints, maintain production-ready code
            - Observability: Uses OpenTelemetry for tracing, structured logging
            - Security: Multi-tenant with organization-based access control
            
            Review ONLY the changes introduced by this PR. Categorize your feedback by severity:
            
            ðŸ”´ **Blocking Issues** (must fix before merge):
            - Security vulnerabilities (SQL injection, XSS, auth bypass, data leaks)
            - Data integrity issues (missing FK constraints, race conditions)
            - Breaking API changes without migration path
            - Critical bugs that cause crashes or data loss
            
            ðŸŸ¡ **Important Issues** (should fix):
            - Performance problems (N+1 queries, missing indexes, memory leaks)
            - Missing error handling or logging
            - Code quality issues (missing type hints, poor naming, duplication)
            - Missing tests for critical paths
            
            ðŸŸ¢ **Suggestions** (nice to have):
            - Code style improvements
            - Better documentation
            - Refactoring opportunities
            - Additional test coverage
            
            For each issue:
            1. Specify the file and line number
            2. Explain the problem clearly
            
            Be concise, specific, and constructive. Skip trivial issues.
            
            Pull request title and body:
            ----
            ${{ github.event.pull_request.title }}
            
            ${{ github.event.pull_request.body }}

  post-feedback:
    runs-on: ubuntu-latest
    needs: codex-review-backend
    permissions:
      issues: write
      pull-requests: write
    
    steps:
      - name: Post Codex feedback as PR comment
        uses: actions/github-script@v7
        env:
          CODEX_FINAL_MESSAGE: ${{ needs.codex-review-backend.outputs.final_message }}
        with:
          github-token: ${{ github.token }}
          script: |
            const message = process.env.CODEX_FINAL_MESSAGE;
            const hasBlockingIssues = message.includes('ðŸ”´');
            const emoji = hasBlockingIssues ? 'ðŸš¨' : 'âœ…';
            const title = hasBlockingIssues ? 'Codex Review - Issues Found' : 'Codex Review - Looks Good';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `## ${emoji} ${title}\n\n${message}\n\n---\n*Powered by OpenAI Codex*`,
            });
