---
import {
  fetchPageData,
  parseSlug,
  fetchBlogList,
  fetchBlogPost,
  fetchSearchResults,
  WebsiteDataTypes,
  type PageData,
  type BlogListData,
  type BlogPostData,
  type SearchResultsData,
} from '@deepsel/cms-utils';
import {
  getPageThemeComponent,
  getBlogListThemeComponent,
  getBlogPostThemeComponent,
  getSearchThemeComponent,
} from '../utils/getThemeComponent';

const { slug = '/' } = Astro.params;
const { lang, path, pathType, pagination } = parseSlug(slug);

let ThemeComponent: any;
let pageData: PageData | null = null;
let blogListData: BlogListData | null = null;
let blogPostData: BlogPostData | null = null;
let searchData: SearchResultsData | null = null;

if (pathType === WebsiteDataTypes.Page) {
  pageData = await fetchPageData({ path, lang, astroRequest: Astro.request });
  ThemeComponent = getPageThemeComponent(pageData, lang);
} else if (pathType === WebsiteDataTypes.BlogList) {
  blogListData = await fetchBlogList({ lang, pagination, astroRequest: Astro.request });
  ThemeComponent = getBlogListThemeComponent(blogListData, lang);
} else if (pathType === WebsiteDataTypes.BlogPost) {
  blogPostData = await fetchBlogPost({ path, lang, astroRequest: Astro.request });
  ThemeComponent = getBlogPostThemeComponent(blogPostData, lang);
} else if (pathType === WebsiteDataTypes.SearchResults) {
  const url = new URL(Astro.request.url);
  const q = url.searchParams.get('q') || '';
  searchData = await fetchSearchResults({ lang, q, astroRequest: Astro.request });
  ThemeComponent = getSearchThemeComponent(searchData, lang);
} else {
  pageData = await fetchPageData({ path, lang, astroRequest: Astro.request });
  ThemeComponent = getPageThemeComponent(pageData, lang);
}
---

{
  pathType === WebsiteDataTypes.Page ? (
    <ThemeComponent data={pageData} />
  ) : pathType === WebsiteDataTypes.BlogList ? (
    <ThemeComponent data={blogListData} />
  ) : pathType === WebsiteDataTypes.BlogPost ? (
    <ThemeComponent data={blogPostData} />
  ) : pathType === WebsiteDataTypes.SearchResults ? (
    <ThemeComponent data={searchData} />
  ) : null
}
