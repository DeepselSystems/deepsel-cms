---
import {
  fetchPageData,
  parseSlugForLangAndPath,
  fetchBlogList,
  fetchBlogPost,
} from "@deepsel/cms-utils";
import type { PageData, BlogListResponse, BlogPostResponse } from "@deepsel/cms-utils";
import { themeMap } from "../themes.js";

const { slug = "/" } = Astro.params;
const { lang, path } = parseSlugForLangAndPath(slug);
const pathType: PathType = getPathType(path);
const isPreviewMode = Astro.url.searchParams.get("preview") === "true";

if (pathType === "BlogList") {
  const blogListData: BlogListResponse = await fetchBlogList(
    lang=lang,
    undefined,
    undefined,
    undefined,
    Astro.request
  );
}

const pageData: PageData = await fetchPageData(
  lang,
  path,
  isPreviewMode,
  null,
  Astro.request,
);
const selectedTheme = pageData.public_settings
  ?.selected_theme as keyof typeof themeMap;
const defaultLanguageIsoCode =
  pageData.public_settings?.default_language?.iso_code || null;

// Determine which theme component to use based on pageData.slug
let ThemeComponent;
if (pageData.notFound) {
  ThemeComponent = themeMap[selectedTheme]["404"];
  Astro.response.status = 404;
} else {
  const pageSlug = pageData.slug?.replace(/^\//, "").toLowerCase() || "index";
  const isNonDefaultLang =
    lang && defaultLanguageIsoCode && lang !== defaultLanguageIsoCode;
  const langPrefix = isNonDefaultLang ? `${lang}:` : "";
  ThemeComponent =
    themeMap[selectedTheme][
      `${langPrefix}${pageSlug}` as keyof (typeof themeMap)[typeof selectedTheme]
    ] ||
    themeMap[selectedTheme][
      pageSlug as keyof (typeof themeMap)[typeof selectedTheme]
    ] ||
    themeMap[selectedTheme]["index"];
}
---

<ThemeComponent pageData={pageData} />
